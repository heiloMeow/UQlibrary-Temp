<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时温度监控</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; line-height: 1.6; }
        .device { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; transition: all 0.3s ease; }
        .online { color: #28a745; }
        .offline { color: #dc3545; }
        .voted { background-color: #f1f8e9; border-color: #c8e6c9; }
        .warm { background-color: #fff8e1; }
        .cold { background-color: #e3f2fd; }
        .conf { background-color: #f5f5f5; }
        #updates { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; }
        .update-item { margin: 5px 0; padding: 8px 12px; border-radius: 4px; }
        .stats { margin: 20px 0; padding: 20px; background-color: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .note { color: #666; font-style: italic; font-size: 0.9em; margin-bottom: 15px; }
        .error { color: #dc3545; padding: 10px; background-color: #f8d7da; border-radius: 4px; margin: 10px 0; }
        .debug { font-size: 0.8em; color: #666; margin-top: 10px; padding: 8px; background-color: #f9f9f9; border-radius: 4px; }
        .stat-item { margin: 12px 0; padding: 5px 0; }
        .stat-label { display: inline-block; width: 120px; font-weight: bold; }
        .stat-value { display: inline-block; }
        .stat-summary { margin: 15px 0; padding: 10px; background-color: #e9f5ff; border-radius: 6px; }
        .voting-status { font-size: 1.1em; padding: 5px 0; }
        .device-count { font-weight: bold; color: #007bff; }
        .time-window { color: #6c757d; font-size: 0.9em; }
        .warning { color: #e67700; }

        /* ---- 历史记录弹窗样式 ---- */
        .history-dialog { width: min(720px, 92vw); border: none; border-radius: 12px; padding: 0;
          box-shadow: 0 20px 60px rgba(0,0,0,.25); }
        .history-dialog::backdrop { background: rgba(0,0,0,.4); }

        .history-head { display: flex; justify-content: space-between; align-items: center;
          padding: 14px 16px; border-bottom: 1px solid #eee; }
        .history-head h3 { margin: 0; font-size: 18px; }
        .close-btn { border: none; background: transparent; font-size: 20px; line-height: 1;
          cursor: pointer; padding: 4px 8px; }

        .history-content { max-height: 60vh; overflow: auto; padding: 12px 16px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .history-table th, .history-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; text-align: left; }
        .history-table tr:hover { background: #f9fbff; }

        .vote-chip { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #e5e7eb; }
        .vote-warm { background: #fff4e6; border-color: #ffd8a8; }
        .vote-conf { background: #f1f5f9; border-color: #e2e8f0; }
        .vote-cold { background: #e7f5ff; border-color: #a5d8ff; }

        .history-actions { display: flex; justify-content: flex-end; gap: 8px; padding: 12px 16px; border-top: 1px solid #eee; }
        .history-actions button { padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; background: white; cursor: pointer; }
    </style>
</head>
<body>
    <h1>实时温度监控</h1>
    <p class="note">系统已自动处理重复投票，同一设备的投票仅计一次</p>
    
    <div class="stats">
        <h3>温度投票统计结果</h3>
        
        <div class="stat-summary">
            <p class="voting-status">在当前统计周期内，共有 <span class="device-count" id="total-devices">0</span> 台设备参与了投票</p>
            <p>大多数人认为环境温度偏 <span id="dominant-vote">--</span></p>
        </div>
        
        <div id="vote-stats">
            <div class="stat-item">
                <span class="stat-label">感觉寒冷：</span>
                <span class="stat-value" id="cold-count">0</span> 人
            </div>
            <div class="stat-item">
                <span class="stat-label">感觉适宜：</span>
                <span class="stat-value" id="conf-count">0</span> 人
            </div>
            <div class="stat-item">
                <span class="stat-label">感觉温暖：</span>
                <span class="stat-value" id="warm-count">0</span> 人
            </div>
            <div class="stat-item">
                <span class="stat-label">统计周期：</span>
                <span class="stat-value" id="time-window">5分钟</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">数据更新时间：</span>
                <span class="stat-value" id="update-time">--</span>
            </div>
        </div>
        
        <div id="stats-error" class="error" style="display: none;"></div>
        <div id="stats-debug" class="debug"></div>
        
        <div style="margin-top: 15px;">
            <button onclick="refreshVoteStats()" style="padding: 6px 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">刷新统计</button>
            <select id="vote-window" onchange="refreshVoteStats()" style="margin-left: 10px; padding: 6px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="60">1分钟</option>
                <option value="300" selected="">5分钟</option>
                <option value="600">10分钟</option>
                <option value="1800">30分钟</option>
                <option value="3600">1小时</option>
            </select>
        </div>
    </div>

    <h2>设备状态列表</h2>
    <div id="snapshot">加载中...</div>

    <h2>最新动态</h2>
    <div id="updates"></div>

    <!-- 历史记录对话框 -->
    <dialog id="historyDialog" class="history-dialog" aria-labelledby="historyTitle">
        <form method="dialog" class="history-head">
            <h3 id="historyTitle">历史记录</h3>
            <button class="close-btn" aria-label="关闭">×</button>
        </form>

        <div class="history-content">
            <table class="history-table">
                <thead>
                    <tr><th>时间</th><th>温度(°C)</th><th>投票</th></tr>
                </thead>
                <tbody id="historyTbody">
                    <tr><td colspan="3">加载中…</td></tr>
                </tbody>
            </table>
        </div>

        <div class="history-actions">
            <button id="copyHistoryBtn" type="button">复制为 CSV</button>
        </div>
    </dialog>

    <script>
        let devicesCache = [];
        let lastStatsUpdate = 0;
        
        const sse = new EventSource('http://localhost:5000/api/sse');
        
        sse.addEventListener('snapshot', (event) => {
            try {
                const data = JSON.parse(event.data);
                devicesCache = data.devices;
                renderDevices();
                refreshVoteStats();
            } catch (err) {
                console.error('快照数据解析失败:', err);
            }
        });

        sse.addEventListener('temp', (event) => {
            try {
                const newData = JSON.parse(event.data);
                const deviceIndex = devicesCache.findIndex(d => d.uid === newData.uid);
                if (deviceIndex > -1) {
                    devicesCache[deviceIndex] = { ...devicesCache[deviceIndex], ...newData };
                } else {
                    devicesCache.push(newData);
                }

                const voteStatusChanged = newData.vote !== null && newData.vote !== undefined && 
                                         (devicesCache[deviceIndex]?.vote !== newData.vote || deviceIndex === -1);

                addUpdate(newData, voteStatusChanged);
                renderDevices();
                
                const now = Date.now();
                if (voteStatusChanged || now - lastStatsUpdate > 3000) {
                    refreshVoteStats();
                    lastStatsUpdate = now;
                }
            } catch (err) {
                console.error('实时数据处理失败:', err);
            }
        });

        sse.onerror = (error) => {
            console.error('SSE 连接错误:', error);
        };

        function renderDevices() {
            const snapshotDiv = document.getElementById('snapshot');
            
            if (devicesCache.length === 0) {
                snapshotDiv.innerHTML = '<p>暂无设备连接</p>';
                return;
            }
            
            let html = '<div class="devices-container">';
            devicesCache.forEach(device => {
                const hasVoted = device.vote !== null && device.vote !== undefined;
                const statusText = device.online ? '在线' : '离线';
                const statusClass = device.online ? 'online' : 'offline';
                
                html += `
                <div class="device ${device.vote_tag || ''} ${hasVoted ? 'voted' : ''}">
                    <h3>设备 ${device.uid} ${hasVoted ? '<small>(已投票)</small>' : ''}</h3>
                    <p>当前温度: ${device.temp}°C</p>
                    <p>温度感受: ${getVoteText(device.vote)}</p>
                    <p>设备状态: <span class="${statusClass}">${statusText}</span></p>
                    <p>最后更新: ${device.iso || new Date(device.ts * 1000).toLocaleString()}</p>
                    <button onclick="showHistory('${device.uid}')" style="margin-top: 8px; padding: 4px 8px; border-radius: 3px; border: 1px solid #ddd;">查看历史记录</button>
                </div>
                `;
            });
            html += '</div>';
            snapshotDiv.innerHTML = html;
        }

        function addUpdate(data, isNewVote) {
            const updatesDiv = document.getElementById('updates');
            const time = new Date(data.ts * 1000).toLocaleString();
            const voteStatus = data.vote !== null && data.vote !== undefined 
                ? (isNewVote ? '提交了新投票' : '更新了投票') 
                : '更新了温度数据';
            
            const updateHtml = `
                <div class="update-item ${data.vote_tag || ''}">
                    [${time}] 设备 ${data.uid} ${voteStatus} - 当前温度: ${data.temp}°C, 感受: ${getVoteText(data.vote)}
                </div>
            `;
            updatesDiv.insertAdjacentHTML('afterbegin', updateHtml);
            
            if (updatesDiv.children.length > 50) {
                updatesDiv.removeChild(updatesDiv.lastChild);
            }
        }

        function getVoteText(vote) {
            if (vote === null || vote === undefined) return '未投票';
            switch(vote) {
                case 1: return '温暖';
                case -1: return '寒冷';
                case 0: return '适宜';
                default: return '未知';
            }
        }

        function refreshVoteStats() {
            const statsError = document.getElementById('stats-error');
            const statsDebug = document.getElementById('stats-debug');
            const totalDevicesEl = document.getElementById('total-devices');
            const dominantVoteEl = document.getElementById('dominant-vote');
            const coldCountEl = document.getElementById('cold-count');
            const confCountEl = document.getElementById('conf-count');
            const warmCountEl = document.getElementById('warm-count');
            const timeWindowEl = document.getElementById('time-window');
            const updateTimeEl = document.getElementById('update-time');
            
            statsError.style.display = 'none';
            statsError.textContent = '';
            statsDebug.textContent = '';
            dominantVoteEl.textContent = '计算中...';
            
            const window = document.getElementById('vote-window').value;
            const windowText = {
                '60': '1分钟',
                '300': '5分钟',
                '600': '10分钟',
                '1800': '30分钟',
                '3600': '1小时'
            }[window] || `${window}秒`;
            timeWindowEl.textContent = windowText;
            
            const url = `http://localhost:5000/api/vote_stats?window=${window}&t=${Date.now()}`;
            const nowTime = new Date().toLocaleTimeString();
            statsDebug.textContent = `[${nowTime}] 正在获取统计数据...`;
            
            fetch(url, { 
                method: 'GET',
                cache: 'no-store'
            })
            .then(response => {
                statsDebug.textContent += ` 服务器响应: ${response.status}`;
                if (!response.ok) {
                    throw new Error(`服务器返回错误: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const dataKeys = Object.keys(data);
                const hasPerUid = dataKeys.includes('per_uid');
                const { warm = 0, conf = 0, cold = 0 } = (data.total || {});
                const totalVotedDevices = hasPerUid ? Object.keys(data.per_uid).length : 0;
                const updateTime = new Date(data.now * 1000).toLocaleString();
                
                statsDebug.textContent = `[${nowTime}] 统计数据更新完成 → 包含字段: ${JSON.stringify(dataKeys)}`;
                if (!hasPerUid) {
                    statsDebug.classList.add('warning');
                    statsDebug.textContent += ' (注意：缺少per_uid字段，设备计数可能不准确)';
                }
                
                coldCountEl.textContent = cold;
                confCountEl.textContent = conf;
                warmCountEl.textContent = warm;
                totalDevicesEl.textContent = totalVotedDevices;
                updateTimeEl.textContent = updateTime;
                
                const maxVote = Math.max(cold, conf, warm);
                if (maxVote === 0) {
                    dominantVoteEl.textContent = '暂无有效投票';
                } else if (cold === maxVote && conf === maxVote && warm === maxVote) {
                    dominantVoteEl.textContent = '各执一词（势均力敌）';
                } else if (cold === maxVote) {
                    dominantVoteEl.textContent = '寒冷';
                } else if (warm === maxVote) {
                    dominantVoteEl.textContent = '温暖';
                } else {
                    dominantVoteEl.textContent = '适宜';
                }
            })
            .catch(error => {
                console.error('统计更新失败:', error);
                statsError.style.display = 'block';
                statsError.textContent = `获取统计数据失败: ${error.message}`;
                statsDebug.textContent += ` → 错误: ${error.message}`;
            });
        }

        // 投票类别样式映射
        function voteClass(v) {
            if (v === 1) return 'vote-warm';
            if (v === 0) return 'vote-conf';
            if (v === -1) return 'vote-cold';
            return '';
        }

        // 显示历史记录（采用新的表格+dialog实现）
        function showHistory(uid) {
            const dialog = document.getElementById('historyDialog');
            const tbody  = document.getElementById('historyTbody');
            const title  = document.getElementById('historyTitle');
            const copyBtn = document.getElementById('copyHistoryBtn');

            title.textContent = `设备 ${uid} 的历史记录`;
            tbody.innerHTML = `<tr><td colspan="3">加载中…</td></tr>`;

            fetch(`http://localhost:5000/api/temps/${uid}/history?${Date.now()}`)
                .then(r => r.json())
                .then(data => {
                    // 最多展示最近200条记录
                    const rows = (data.history || []).slice(-200);
                    if (!rows.length) {
                        tbody.innerHTML = `<tr><td colspan="3">暂无历史记录</td></tr>`;
                        return;
                    }
                    
                    // 按时间升序展示（最新的在后），如需最新在前可使用 rows.reverse()
                    tbody.innerHTML = rows.map(it => {
                        const t  = new Date(it.ts * 1000).toLocaleString();
                        const v  = it.vote;
                        const cl = voteClass(v);
                        const lb = getVoteText(v);   // 复用现有的文字映射
                        const tp = (it.temp ?? '—');
                        const chip = `<span class="vote-chip ${cl}">${lb}</span>`;
                        return `<tr><td>${t}</td><td>${tp}</td><td>${chip}</td></tr>`;
                    }).join('');

                    // 复制为CSV功能
                    copyBtn.onclick = () => {
                        const csv = ['time,temp,vote_text,vote_raw'].concat(
                            rows.map(it => {
                                const iso = new Date(it.ts * 1000).toISOString();
                                const lb  = getVoteText(it.vote);
                                return `${iso},${it.temp ?? ''},${lb},${it.vote}`;
                            })
                        ).join('\n');
                        navigator.clipboard.writeText(csv).then(() => {
                            copyBtn.textContent = '已复制';
                            setTimeout(() => (copyBtn.textContent = '复制为 CSV'), 1200);
                        });
                    };
                })
                .catch(err => {
                    tbody.innerHTML = `<tr><td colspan="3" style="color:#dc3545;">获取历史记录失败：${err.message}</td></tr>`;
                })
                .finally(() => {
                    if (!dialog.open) dialog.showModal();
                });

            // 点击遮罩关闭（一次性绑定）
            dialog.addEventListener('click', (e) => { if (e.target === dialog) dialog.close(); }, { once: true });
        }

        window.addEventListener('load', () => {
            setTimeout(refreshVoteStats, 1000);
        });
    </script>
</body></html>
