<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real-time Temperature Monitoring</title>
  <style>
    :root { --ok:#28a745; --down:#dc3545; --link:#007bff; }
    body { font-family: Arial, sans-serif; max-width:1200px; margin:0 auto; padding:20px; line-height:1.6; }
    h1 { margin-bottom: 6px; }
    .note { color:#666; font-style: italic; font-size:.9em; margin:0 0 15px; }
    .stats { margin:20px 0; padding:20px; background:#f8f9fa; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.05); }
    .stat-item { margin:12px 0; padding:5px 0; }
    .stat-label { display:inline-block; width:120px; font-weight:bold; }
    .stat-summary { margin:15px 0; padding:10px; background:#e9f5ff; border-radius:6px; }
    .device-count { font-weight:bold; color: var(--link); }
    .error { color:#dc3545; padding:10px; background:#f8d7da; border-radius:4px; margin:10px 0; }
    .debug { font-size:.8em; color:#666; margin-top:10px; padding:8px; background:#f9f9f9; border-radius:4px; }
    .warning { color:#e67700; }

    /* 设备卡片 */
    .device { border:1px solid #ddd; border-radius:8px; padding:15px; margin:10px 0; transition: all .3s ease; }
    .online { color:#28a745; }
    .offline { color:#dc3545; }
    .voted { background:#f1f8e9; border-color:#c8e6c9; }
    .warm { background:#fff8e1; }
    .cold { background:#e3f2fd; }
    .conf { background:#f5f5f5; }

    #updates { margin-top:30px; padding-top:20px; border-top:2px solid #eee; }
    .update-item { margin:5px 0; padding:8px 12px; border-radius:4px; }

    /* 顶部连接状态 */
    .conn { display:inline-flex; align-items:center; gap:8px; font-size:.95em; padding:6px 10px; border-radius:999px; }
    .dot { width:10px; height:10px; border-radius:50%; background: var(--ok); }
    .down .dot { background: var(--down); }
    .down { background: #fde8ea; color:#b02a37; }
    .ok { background: #e8f8ef; color:#0f5132; }

    /* 历史记录弹窗样式 */
    .history-dialog { width:min(720px,92vw); border:none; border-radius:12px; padding:0; box-shadow:0 20px 60px rgba(0,0,0,.25); }
    .history-dialog::backdrop { background: rgba(0,0,0,.4); }
    .history-head { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #eee; }
    .history-head h3 { margin:0; font-size:18px; }
    .close-btn { border:none; background:transparent; font-size:20px; line-height:1; cursor:pointer; padding:4px 8px; }
    .history-content { max-height:60vh; overflow:auto; padding:12px 16px; }
    .history-table { width:100%; border-collapse:collapse; font-size:14px; }
    .history-table th, .history-table td { padding:8px 10px; border-bottom:1px solid #f0f0f0; text-align:left; }
    .history-table tr:hover { background:#f9fbff; }
    .vote-chip { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; }
    .vote-warm { background:#fff4e6; border-color:#ffd8a8; }
    .vote-conf { background:#f1f5f9; border-color:#e2e8f0; }
    .vote-cold { background:#e7f5ff; border-color:#a5d8ff; }
    .history-actions { display:flex; justify-content:flex-end; gap:8px; padding:12px 16px; border-top:1px solid #eee; }
    .history-actions button { padding:6px 12px; border-radius:6px; border:1px solid #ddd; background:white; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Real-time Temperature Monitoring</h1>
  <p class="note">The system automatically handles duplicate votes: only the most recent vote from each device is counted within the statistical period.</p>

  <div id="conn" class="conn ok" aria-live="polite">
    <span class="dot" aria-hidden="true"></span>
    <span id="conn-text">Live connection active</span>
  </div>

  <div class="stats">
    <h3>Temperature Voting Statistics</h3>
    <div class="stat-summary">
      <p class="voting-status">In the current statistical period, <span class="device-count" id="total-devices">0</span> devices have participated in voting</p>
      <p>Most people feel the temperature is <span id="dominant-vote">--</span></p>
    </div>

    <div id="vote-stats">
      <div class="stat-item"><span class="stat-label">Feeling Cold:</span><span class="stat-value" id="cold-count">0</span> people</div>
      <div class="stat-item"><span class="stat-label">Feeling Comfortable:</span><span class="stat-value" id="conf-count">0</span> people</div>
      <div class="stat-item"><span class="stat-label">Feeling Warm:</span><span class="stat-value" id="warm-count">0</span> people</div>
      <div class="stat-item"><span class="stat-label">Statistical Period:</span><span class="stat-value" id="time-window">5 minutes</span></div>
      <div class="stat-item"><span class="stat-label">Last Update:</span><span class="stat-value" id="update-time">--</span></div>
    </div>

    <div id="stats-error" class="error" style="display:none;"></div>
    <div id="stats-debug" class="debug"></div>

    <div style="margin-top:15px;">
      <button onclick="refreshVoteStats()" style="padding:6px 12px; background:var(--link); color:#fff; border:none; border-radius:4px; cursor:pointer;">Refresh Statistics</button>
      <select id="vote-window" onchange="refreshVoteStats()" style="margin-left:10px; padding:6px; border-radius:4px; border:1px solid #ddd;">
        <option value="60">1 minute</option>
        <option value="300" selected>5 minutes</option>
        <option value="600">10 minutes</option>
        <option value="1800">30 minutes</option>
        <option value="3600">1 hour</option>
      </select>
    </div>
  </div>

  <h2>Device Status List</h2>
  <div id="snapshot">Loading...</div>

  <h2>Latest Updates</h2>
  <div id="updates"></div>

  <!-- 历史记录对话框 -->
  <dialog id="historyDialog" class="history-dialog" aria-labelledby="historyTitle">
    <form method="dialog" class="history-head">
      <h3 id="historyTitle">History</h3>
      <button class="close-btn" aria-label="Close">×</button>
    </form>

    <div class="history-content">
      <table class="history-table">
        <thead><tr><th>Time</th><th>Temperature(°C)</th><th>Vote</th></tr></thead>
        <tbody id="historyTbody"><tr><td colspan="3">Loading…</td></tr></tbody>
      </table>
    </div>

    <div class="history-actions">
      <button id="copyHistoryBtn" type="button">Copy as CSV</button>
    </div>
  </dialog>

  <script>
    // ===== 基础配置：同域相对路径 + 子路径兼容 =====
    const API_BASE = new URL('.', location.href).pathname.replace(/\/$/, '');
    const api = (p) => `${API_BASE}${p}`;

    let devicesCache = [];
    let lastStatsUpdate = 0;

    // ===== SSE：实时数据流 =====
    const sse = new EventSource(api('/api/sse')); // 同域，避免 CORS/重定向引发问题
    const conn = document.getElementById('conn');
    const connText = document.getElementById('conn-text');

    sse.addEventListener('open', () => {
      conn.classList.remove('down'); conn.classList.add('ok');
      connText.textContent = 'Live connection active';
    });

    sse.addEventListener('error', () => {
      // 浏览器通常会自动重连，但若遇到 4xx/5xx 可能不会；至少给用户提示。:contentReference[oaicite:4]{index=4}
      conn.classList.remove('ok'); conn.classList.add('down');
      connText.textContent = 'Connection error, attempting to reconnect…';
    });

    sse.addEventListener('snapshot', (event) => {
      try {
        const data = JSON.parse(event.data);
        devicesCache = data.devices || [];
        renderDevices();
        refreshVoteStats();
      } catch (err) { console.error('Failed to parse snapshot data:', err); }
    });

    sse.addEventListener('temp', (event) => {
      try {
        const newData = JSON.parse(event.data);
        const i = devicesCache.findIndex(d => d.uid === newData.uid);
        const prevVote = i > -1 ? devicesCache[i].vote : undefined;  // 先取旧值
        if (i > -1) devicesCache[i] = { ...devicesCache[i], ...newData };
        else devicesCache.push(newData);

        const voteStatusChanged = (newData.vote !== null && newData.vote !== undefined) &&
                                  (i === -1 || prevVote !== newData.vote);

        addUpdate(newData, voteStatusChanged);
        renderDevices();

        const now = Date.now();
        if (voteStatusChanged || now - lastStatsUpdate > 3000) {
          refreshVoteStats();
          lastStatsUpdate = now;
        }
      } catch (err) { console.error('Failed to process real-time data:', err); }
    });

    // ===== UI 渲染 =====
    function renderDevices() {
      const box = document.getElementById('snapshot');
      if (!devicesCache.length) { box.innerHTML = '<p>No devices connected</p>'; return; }

      let html = '<div class="devices-container">';
      for (const d of devicesCache) {
        const hasVoted = d.vote !== null && d.vote !== undefined;
        const statusText = d.online ? 'Online' : 'Offline';
        const statusClass = d.online ? 'online' : 'offline';
        html += `
          <div class="device ${d.vote_tag || ''} ${hasVoted ? 'voted' : ''}">
            <h3>Device ${d.uid} ${hasVoted ? '<small>(Voted)</small>' : ''}</h3>
            <p>Current Temperature: ${d.temp}°C</p>
            <p>Temperature Feeling: ${getVoteText(d.vote)}</p>
            <p>Device Status: <span class="${statusClass}">${statusText}</span></p>
            <p>Last Update: ${d.iso || new Date(d.ts * 1000).toLocaleString()}</p>
            <button onclick="showHistory('${d.uid}')" style="margin-top:8px; padding:4px 8px; border-radius:3px; border:1px solid #ddd;">View History</button>
          </div>`;
      }
      html += '</div>';
      box.innerHTML = html;
    }

    function addUpdate(data, isNewVote) {
      const updatesDiv = document.getElementById('updates');
      const time = new Date(data.ts * 1000).toLocaleString();
      const voteStatus = (data.vote !== null && data.vote !== undefined)
        ? (isNewVote ? 'submitted a new vote' : 'updated vote')
        : 'updated temperature data';
      const updateHtml = `
        <div class="update-item ${data.vote_tag || ''}">
          [${time}] Device ${data.uid} ${voteStatus} - Current Temperature: ${data.temp}°C, Feeling: ${getVoteText(data.vote)}
        </div>`;
      updatesDiv.insertAdjacentHTML('afterbegin', updateHtml);
      if (updatesDiv.children.length > 50) updatesDiv.removeChild(updatesDiv.lastChild);
    }

    // ===== 统计 =====
    function refreshVoteStats() {
      const statsError = document.getElementById('stats-error');
      const statsDebug = document.getElementById('stats-debug');
      const totalDevicesEl = document.getElementById('total-devices');
      const dominantVoteEl = document.getElementById('dominant-vote');
      const coldCountEl = document.getElementById('cold-count');
      const confCountEl = document.getElementById('conf-count');
      const warmCountEl = document.getElementById('warm-count');
      const timeWindowEl = document.getElementById('time-window');
      const updateTimeEl = document.getElementById('update-time');

      statsError.style.display = 'none';
      statsError.textContent = '';
      statsDebug.textContent = '';
      dominantVoteEl.textContent = 'Calculating...';

      const win = document.getElementById('vote-window').value;
      const winText = ({'60':'1 minute','300':'5 minutes','600':'10 minutes','1800':'30 minutes','3600':'1 hour'})[win] || `${win} seconds`;
      timeWindowEl.textContent = winText;

      const url = api(`/api/vote_stats?window=${win}&t=${Date.now()}`);
      const nowTime = new Date().toLocaleTimeString();
      statsDebug.textContent = `[${nowTime}] Fetching statistics…`;

      fetch(url, { method:'GET', cache:'no-store' })
        .then(r => { statsDebug.textContent += ` Response: ${r.status}`; if (!r.ok) throw new Error(`Server error: ${r.status}`); return r.json(); })
        .then(data => {
          const keys = Object.keys(data||{});
          const hasPerUid = keys.includes('per_uid');
          const total = data.total || {};
          const warm = total.warm || 0, conf = total.conf || 0, cold = total.cold || 0;

          // 优先使用后端 device_count；否则回退到 per_uid 的唯一设备数
          const totalVotedDevices = Number.isFinite(data.device_count)
            ? data.device_count
            : (hasPerUid ? Object.keys(data.per_uid).length : 0);

          coldCountEl.textContent = cold;
          confCountEl.textContent = conf;
          warmCountEl.textContent = warm;
          totalDevicesEl.textContent = totalVotedDevices;
          updateTimeEl.textContent = new Date((data.now || Date.now()/1000) * 1000).toLocaleString();

          statsDebug.textContent = `[${nowTime}] Data fields: ${JSON.stringify(keys)}`;
          if (!hasPerUid && !Number.isFinite(data.device_count)) {
            statsDebug.classList.add('warning');
            statsDebug.textContent += ' (Note: Missing per_uid / device_count, device count may be inaccurate)';
          }

          const maxVote = Math.max(cold, conf, warm);
          dominantVoteEl.textContent = (maxVote === 0) ? 'No valid votes yet'
            : (cold === maxVote && conf === maxVote && warm === maxVote) ? 'Evenly divided'
            : (cold === maxVote) ? 'Cold'
            : (warm === maxVote) ? 'Warm' : 'Comfortable';
        })
        .catch(err => {
          console.error('Failed to update statistics:', err);
          statsError.style.display = 'block';
          statsError.textContent = `Failed to fetch statistics: ${err.message}`;
          statsDebug.textContent += ` → Error: ${err.message}`;
        });
    }

    // ===== 历史记录 =====
    function voteClass(v) { if (v===1) return 'vote-warm'; if (v===0) return 'vote-conf'; if (v===-1) return 'vote-cold'; return ''; }
    function getVoteText(v) { if (v===1) return 'Warm'; if (v===-1) return 'Cold'; if (v===0) return 'Comfortable'; if (v===null || v===undefined) return 'Not voted'; return 'Unknown'; }

    function showHistory(uid) {
      const dialog = document.getElementById('historyDialog');
      const tbody  = document.getElementById('historyTbody');
      const title  = document.getElementById('historyTitle');
      const copyBtn= document.getElementById('copyHistoryBtn');

      title.textContent = `Device ${uid} History`;
      tbody.innerHTML = `<tr><td colspan="3">Loading…</td></tr>`;

      fetch(api(`/api/temps/${uid}/history?${Date.now()}`))
        .then(r => r.json())
        .then(data => {
          const rows = (data.history || []).slice(-200);
          if (!rows.length) { tbody.innerHTML = `<tr><td colspan="3">No history available</td></tr>`; return; }

          tbody.innerHTML = rows.map(it => {
            const t = new Date(it.ts * 1000).toLocaleString();
            const cl = voteClass(it.vote);
            const chip = `<span class="vote-chip ${cl}">${getVoteText(it.vote)}</span>`;
            return `<tr><td>${t}</td><td>${it.temp ?? '—'}</td><td>${chip}</td></tr>`;
          }).join('');

          copyBtn.onclick = () => {
            const csv = ['time,temp,vote_text,vote_raw'].concat(
              rows.map(it => `${new Date(it.ts*1000).toISOString()},${it.temp ?? ''},${getVoteText(it.vote)},${it.vote}`)
            ).join('\n');
            navigator.clipboard.writeText(csv).then(() => {
              copyBtn.textContent = 'Copied!'; setTimeout(() => copyBtn.textContent='Copy as CSV', 1200);
            });
          };
        })
        .catch(err => { tbody.innerHTML = `<tr><td colspan="3" style="color:#dc3545;">Failed to fetch history: ${err.message}</td></tr>`; })
        .finally(() => { if (!dialog.open) dialog.showModal(); });

      dialog.addEventListener('click', (e) => { if (e.target === dialog) dialog.close(); }, { once:true });
    }

    window.addEventListener('load', () => { setTimeout(refreshVoteStats, 1000); });
  </script>
</body>
</html>
